<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ä¸­èˆˆèª²è¡¨ï¼ˆè‡ªå¡«ï¼QR åŒ¯å…¥ï¼‰</title>

    <!-- ç°¡æ½”æ¨£å¼ï¼ˆè‹¥ä½ å·²æœ‰ style.cssï¼Œå¯æ”¹æˆå¤–é€£ï¼‰ -->
    <style>
        :root {
            --bg: #0e1621;
            --panel: #111b27;
            --grid: #2a3a4a;
            --text: #c7efff;
            --muted: #8fb7cc;
            --brand: #2eaadc;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial,"Noto Sans TC"
        }

        .wrap {
            max-width: 1100px;
            margin: 32px auto 80px;
            padding: 0 16px
        }

        h1 {
            font-size: 24px;
            margin: 0 0 16px;
            letter-spacing: .5px
        }

        .toolbar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px
        }

        .btn {
            appearance: none;
            border: 1px solid var(--grid);
            background: var(--panel);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: .3px
        }

            .btn:hover {
                border-color: var(--brand);
                box-shadow: 0 0 0 2px #2eaadc30 inset
            }

            .btn.brand {
                background: #123241;
                border-color: #215e78;
                color: #d9f7ff
            }

            .btn.danger {
                background: #35181a;
                border-color: #6d2a2f;
                color: #ffd6d4
            }

        .table-wrap {
            overflow: auto;
            border-radius: 12px
        }

        .grid {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
            background: var(--panel);
            border: 1px solid var(--grid);
            border-radius: 12px;
            overflow: hidden
        }

            .grid th, .grid td {
                border-right: 1px solid var(--grid);
                border-bottom: 1px solid var(--grid);
                padding: 10px 12px;
                vertical-align: top
            }

                .grid th:last-child, .grid td:last-child {
                    border-right: none
                }

            .grid tr:last-child td {
                border-bottom: none
            }

            .grid thead th {
                background: #0f2230;
                color: #d9f7ff;
                font-weight: 800;
                text-align: center;
                position: sticky;
                top: 0;
                z-index: 1
            }

        .time-cell {
            color: #a6d8ea;
            font-weight: 800;
            text-align: center;
            width: 110px;
            white-space: normal
        }

            .time-cell .line {
                display: block
            }

                .time-cell .line + .line {
                    color: var(--muted);
                    font-weight: 700
                }

        .course {
            display: block;
            padding: 8px 10px;
            border-radius: 10px;
            background: #112838;
            border: 1px solid #2b536a;
            color: #d9f7ff;
            line-height: 1.25;
            margin-bottom: 6px;
            box-shadow: 0 1px 0 0 #000a inset
        }

            .course .name {
                font-weight: 800
            }

            .course .meta {
                font-size: 12px;
                color: #9ed3e6;
                margin-top: 4px
            }
        /* ç°¡å–®éŸ¿æ‡‰å¼ */
        @media (max-width:560px) {
            .time-cell {
                width: 84px
            }

            .toolbar .btn {
                padding: 9px 12px
            }
        }
        /* æƒæå™¨å½ˆçª— */
        #scanner-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: #000a;
            backdrop-filter: blur(2px);
            align-items: center;
            justify-content: center;
            z-index: 10
        }

        #scanner-panel {
            width: min(92vw,520px);
            background: #0f2230;
            border: 1px solid #2a3a4a;
            border-radius: 12px;
            padding: 12px 12px 6px
        }

        #scanner-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }
    </style>

    <!-- QR æƒæå™¨ï¼ˆæ”¯æ´ iOS Safariï¼‰ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

    <!-- PWA (å¯é¸) -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0e1621" />
</head>
<body>
    <div class="wrap">
        <h1>ä¸­èˆˆèª²è¡¨ï¼ˆè‡ªå¡«ï¼QR åŒ¯å…¥ï¼‰</h1>

        <div class="toolbar">
            <button id="btn-scan" class="btn brand">ğŸ“· æƒæ QR</button>
            <button id="btn-paste" class="btn">ğŸ“‹ æ‰‹å‹•è²¼ä¸Š JSON</button>
            <button id="btn-clear" class="btn danger">ğŸ§¹ æ¸…ç©º</button>
        </div>

        <div class="table-wrap">
            <table class="grid" id="table">
                <thead>
                    <tr>
                        <th class="time-cell">æ™‚é–“</th>
                        <th>æ˜ŸæœŸä¸€</th>
                        <th>æ˜ŸæœŸäºŒ</th>
                        <th>æ˜ŸæœŸä¸‰</th>
                        <th>æ˜ŸæœŸå››</th>
                        <th>æ˜ŸæœŸäº”</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- æƒæå™¨ Modal -->
    <div id="scanner-modal">
        <div id="scanner-panel">
            <div id="scanner-head">
                <strong>æƒæ QR Code</strong>
                <button id="scanner-close" class="btn danger" style="padding:.4rem .7rem">é—œé–‰</button>
            </div>
            <div id="qr-reader" style="width:100%"></div>
            <div style="font-size:12px;color:#9ed3e6;margin:8px 2px 2px">
                æŠŠ QR æ”¾åœ¨ç•«é¢ä¸­å¤®ï¼Œå°ç„¦å¾Œè‡ªå‹•è¾¨è­˜ã€‚è‹¥ç„¡æ³•å•Ÿç”¨ç›¸æ©Ÿï¼Œæœƒæä¾›ã€Œä¸Šå‚³åœ–ç‰‡ã€å‚™æ´ã€‚
            </div>
        </div>
    </div>

    <script>
        /************ 1) å›ºå®šæ™‚æ®µï¼ˆå·¦å´é¡¯ç¤ºï¼‰ ************/
        const TIME_SLOTS = [
            ["08:10", "09:00"],
            ["09:10", "10:00"],
            ["10:10", "11:00"],
            ["11:10", "12:00"],
            ["13:10", "14:00"],
            ["14:10", "15:00"],
            ["15:10", "16:00"]
        ]; // éœ€è¦å¢æ¸›å°±æ”¹é€™è£¡

        const tbody = document.getElementById('tbody');

        function buildTable() {
            tbody.innerHTML = '';
            for (const [start, end] of TIME_SLOTS) {
                const tr = document.createElement('tr');

                const tdTime = document.createElement('td');
                tdTime.className = 'time-cell';
                tdTime.innerHTML = `<span class="line">${start}</span><span class="line">${end}</span>`;
                tr.appendChild(tdTime);

                for (let d = 1; d <= 5; d++) {
                    const td = document.createElement('td');
                    td.dataset.day = String(d); // 1..5
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        /************ 2) å„²å­˜ / ç¹ªè£½ ************/
        const LS_KEY = 'nchu-courses';
        const loadCourses = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } };
        const saveCourses = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

        function renderCourses() {
            document.querySelectorAll('#tbody td:not(.time-cell)').forEach(td => td.innerHTML = '');
            const courses = loadCourses();

            for (const course of courses) {
                const { n: name = 'èª²ç¨‹', m: code = '', e: room = '', d = [] } = course;
                for (const seg of d) {
                    const w = Number(seg.w);            // æ˜ŸæœŸ 1..5
                    const slots = (seg.s || []).map(Number); // ç¬¬å¹¾ç¯€ï¼ˆä»¥ TIME_SLOTS çš„ index å°æ‡‰ï¼‰

                    for (const sec of slots) {
                        const row = tbody.rows[sec];
                        if (!row) continue;
                        const td = row.querySelector(`td[data-day="${w}"]`);
                        if (!td) continue;

                        const div = document.createElement('div');
                        div.className = 'course';
                        div.innerHTML = `<div class="name">${name}</div><div class="meta">(${code}) Â· ${room || 'â€”'}</div>`;
                        td.appendChild(div);
                    }
                }
            }
        }

        /************ 3) åŒ¯å…¥ï¼ˆæ‰‹å‹•è²¼ä¸Š / è§£æï¼‰ ************/
        // å¾ä»»æ„å­—ä¸²å–ç¬¬ä¸€å€‹ JSONï¼ˆè™•ç† QR å¯èƒ½å¤¾é›œæ–‡å­—/é€£çµï¼‰
        function extractFirstJSONObject(text) {
            const s = text.indexOf('{'); const e = text.lastIndexOf('}');
            if (s !== -1 && e !== -1 && e > s) {
                try { return JSON.parse(text.slice(s, e + 1)); } catch { }
            }
            return null;
        }

        function importFromJSONString(s) {
            let obj = null;
            try { obj = JSON.parse(s); }
            catch { obj = extractFirstJSONObject(s); }
            if (!obj) throw new Error('ç„¡æ³•è§£æ JSON å…§å®¹');

            const arr = Array.isArray(obj) ? obj : [obj];
            saveCourses(arr);
            buildTable(); renderCourses();
            alert('èª²è¡¨å·²åŒ¯å…¥ï¼');
        }

        document.getElementById('btn-paste').addEventListener('click', () => {
            const s = prompt('è«‹è²¼ä¸Šæ ¡å‹™ç³»çµ±è¼¸å‡ºçš„ JSONï¼š');
            if (!s) return;
            try { importFromJSONString(s); }
            catch (err) { alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message); }
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            if (confirm('ç¢ºå®šæ¸…ç©ºèª²è¡¨å—ï¼Ÿ')) {
                saveCourses([]); buildTable(); renderCourses();
            }
        });

        /************ 4) QR æƒæï¼ˆæ›´ç©©å®š / å«åœ–ç‰‡å‚™æ´ï¼‰ ************/
        const modal = document.getElementById('scanner-modal');
        const btnScan = document.getElementById('btn-scan');
        const btnClose = document.getElementById('scanner-close');
        let qrReader = null;
        let currentCamId = null;

        function onScanSuccess(decodedText) {
            try { importFromJSONString(decodedText); stopScanner(); }
            catch (err) {
                console.warn('QR å…§å®¹ï¼š', decodedText);
                alert('ç„¡æ³•è§£ææ­¤ QR å…§å®¹ï¼Œå·²åˆ—å°åœ¨ consoleï¼ˆè«‹æŠŠå…§å®¹è²¼çµ¦æˆ‘ï¼‰');
            }
        }
        function onScanFailure() { /* ignore continuous errors */ }

        async function startScanner() {
            modal.style.display = 'flex';
            try {
                const cams = await Html5Qrcode.getCameras();
                if (!cams || !cams.length) throw new Error('æ‰¾ä¸åˆ°ç›¸æ©Ÿ');

                const back = cams.find(c => /back|rear|environment/i.test(c.label));
                currentCamId = (back ? back.id : cams[cams.length - 1].id);

                if (!qrReader) {
                    qrReader = new Html5Qrcode("qr-reader", {
                        formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]
                    });
                }
                const config = { fps: 10, qrbox: { width: 260, height: 260 } };
                await qrReader.start(currentCamId, config, onScanSuccess, onScanFailure);
            } catch (e) {
                console.warn('å•Ÿç”¨ç›¸æ©Ÿå¤±æ•—ï¼š', e);
                // åœ–ç‰‡å‚™æ´
                document.getElementById('qr-reader').innerHTML = `
              <div style="padding:10px;color:#9ed3e6;line-height:1.6">
                <div style="margin-bottom:8px;"><b>ç›¸æ©Ÿç„¡æ³•å•Ÿç”¨</b>ï¼ˆå¯èƒ½æœªæˆæ¬Šï¼Œæˆ–é Safariï¼‰ã€‚</div>
                <div style="margin-bottom:10px;">
                  è«‹ç¢ºèªï¼šä½¿ç”¨ <b>Safari</b> é–‹å•Ÿæœ¬é ï¼Œä¸”å·²å…è¨±ç›¸æ©Ÿï¼›<br>
                  æˆ–ç›´æ¥ <b>ä¸Šå‚³å« QR çš„åœ–ç‰‡</b> è¾¨è­˜ï¼š
                </div>
                <input id="qr-file" type="file" accept="image/*" style="display:block">
              </div>`;
                const fileInput = document.getElementById('qr-file');
                fileInput?.addEventListener('change', async () => {
                    const f = fileInput.files?.[0]; if (!f) return;
                    try {
                        if (!qrReader) qrReader = new Html5Qrcode("qr-reader");
                        const result = await qrReader.scanFile(f, true);
                        onScanSuccess(result);
                    } catch (err) { alert('åœ–ç‰‡è¾¨è­˜å¤±æ•—ï¼š' + err); }
                });
            }
        }

        function stopScanner() {
            if (qrReader) {
                qrReader.stop().catch(() => { }).finally(() => {
                    modal.style.display = 'none';
                    document.getElementById('qr-reader').innerHTML = '';
                    qrReader = null; currentCamId = null;
                });
            } else {
                modal.style.display = 'none';
            }
        }
        btnScan.addEventListener('click', startScanner);
        btnClose.addEventListener('click', stopScanner);
        modal.addEventListener('click', e => { if (e.target === modal) stopScanner(); });

        /************ 5) å•Ÿå‹• & PWA ************/
        buildTable(); renderCourses();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.warn);
            });
        }
    </script>
</body>
</html>
