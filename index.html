<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ä¸­èˆˆèª²è¡¨ï¼ˆè‡ªå¡«ï¼QR åŒ¯å…¥ï¼‰</title>

    <!-- é¡è‰²èˆ‡å­—é«” -->
    <style>
        :root {
            --bg: #0e1621; /* èƒŒæ™¯æ·±è— */
            --panel: #111b27; /* é¢æ¿æ·±è— */
            --grid: #2a3a4a; /* æ ¼ç·š */
            --text: #c7efff; /* ä¸»è¦å­— */
            --muted: #8fb7cc; /* æ¬¡è¦å­— */
            --brand: #2eaadc; /* é‡é»è‰² */
            --good: #35c759;
            --danger: #ff3b30;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial,"Noto Sans TC","Apple Color Emoji","Segoe UI Emoji";
        }

        .wrap {
            max-width: 1100px;
            margin: 32px auto 80px;
            padding: 0 16px;
        }

        h1 {
            font-size: 24px;
            margin: 0 0 16px;
            letter-spacing: .5px;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .btn {
            appearance: none;
            border: 1px solid var(--grid);
            background: var(--panel);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: .5px;
            transition: .15s ease;
        }

            .btn:hover {
                border-color: var(--brand);
                box-shadow: 0 0 0 2px #2eaadc30 inset;
            }

            .btn.brand {
                background: #123241;
                border-color: #215e78;
                color: #d9f7ff;
            }

            .btn.danger {
                background: #35181a;
                border-color: #6d2a2f;
                color: #ffd6d4;
            }

        /* è¡¨æ ¼ */
        .grid {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
            background: var(--panel);
            border: 1px solid var(--grid);
            border-radius: 12px;
            overflow: hidden;
        }

            .grid th, .grid td {
                border-right: 1px solid var(--grid);
                border-bottom: 1px solid var(--grid);
                padding: 10px 12px;
                vertical-align: top;
            }

                .grid th:last-child, .grid td:last-child {
                    border-right: none;
                }

            .grid tr:last-child td {
                border-bottom: none;
            }

            .grid thead th {
                background: #0f2230;
                color: #d9f7ff;
                font-weight: 700;
                text-align: center;
                position: sticky;
                top: 0;
                z-index: 1;
            }

        /* å·¦å´æ™‚é–“æ¬„ï¼šå…©è¡Œé¡¯ç¤ºï¼Œä¸å†æœ‰ \n */
        .time-cell {
            color: #a6d8ea;
            font-weight: 700;
            text-align: center;
            width: 110px;
            white-space: normal;
        }

            .time-cell .line {
                display: block;
            }

                .time-cell .line + .line {
                    color: var(--muted);
                    font-weight: 600;
                }

        /* èª²ç¨‹å¡ */
        .course {
            display: block;
            padding: 8px 10px;
            border-radius: 10px;
            background: #112838;
            border: 1px solid #2b536a;
            color: #d9f7ff;
            line-height: 1.25;
            margin-bottom: 6px;
            box-shadow: 0 1px 0 0 #000a inset;
        }

            .course .name {
                font-weight: 800;
            }

            .course .meta {
                font-size: 12px;
                color: #9ed3e6;
                margin-top: 4px;
            }
        /* å°è¢å¹•æ©«å‘æ²å‹• */
        .table-wrap {
            overflow: auto;
            border-radius: 12px;
        }
    </style>

    <!-- QR æƒæå™¨ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0e1621">
</head>
<body>
    <div class="wrap">
        <h1>ä¸­èˆˆèª²è¡¨ï¼ˆè‡ªå¡«ï¼QR åŒ¯å…¥ï¼‰</h1>

        <div class="toolbar">
            <button id="btn-scan" class="btn brand">ğŸ“· æƒæ QR</button>
            <button id="btn-paste" class="btn">ğŸ“‹ æ‰‹å‹•è²¼ä¸Š JSON</button>
            <button id="btn-clear" class="btn danger">ğŸ§¹ æ¸…ç©º</button>
        </div>

        <div class="table-wrap">
            <table class="grid" id="table">
                <thead>
                    <tr>
                        <th class="time-cell">æ™‚é–“</th>
                        <th>æ˜ŸæœŸä¸€</th>
                        <th>æ˜ŸæœŸäºŒ</th>
                        <th>æ˜ŸæœŸä¸‰</th>
                        <th>æ˜ŸæœŸå››</th>
                        <th>æ˜ŸæœŸäº”</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- ç°¡æ˜“æƒæè¦–çª— -->
    <div id="scanner-modal" style="display:none; position:fixed; inset:0; background:#000a; backdrop-filter:blur(2px); align-items:center; justify-content:center; z-index:10;">
        <div style="width:min(92vw,520px); background:#0f2230; border:1px solid #2a3a4a; border-radius:12px; padding:12px 12px 6px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <strong>æƒæ QR Code</strong>
                <button id="scanner-close" class="btn danger" style="padding:.4rem .7rem;">é—œé–‰</button>
            </div>
            <div id="qr-reader" style="width:100%;"></div>
            <div style="font-size:12px; color:#9ed3e6; margin:8px 2px 2px;">æŠŠ QR æ”¾åœ¨ç•«é¢ä¸­å¤®ï¼Œå°ç„¦å¾Œè‡ªå‹•è¾¨è­˜ã€‚</div>
        </div>
    </div>

    <script>
        /********************
         * 1) æ™‚æ®µè³‡æ–™ï¼ˆé€±ä¸€ï½é€±äº”ï¼›æ¯æ ¼ 1 ç¯€ï¼‰
         ********************/
        const TIME_SLOTS = [
            ["08:10", "09:00"],
            ["09:10", "10:00"],
            ["10:10", "11:00"],
            ["11:10", "12:00"],
            ["13:10", "14:00"],
            ["14:10", "15:00"],
            ["15:10", "16:00"]
        ]; // æƒ³åŠ æ¸›æ™‚æ®µï¼Œæ”¹é€™è£¡å°±å¥½

        const tbody = document.getElementById('tbody');

        // å»ºè¡¨ï¼ˆå·¦æ™‚é–“ + 5 å¤©ï¼‰
        function buildTable() {
            tbody.innerHTML = '';
            for (const [start, end] of TIME_SLOTS) {
                const tr = document.createElement('tr');

                const tdTime = document.createElement('td');
                tdTime.className = 'time-cell';
                tdTime.innerHTML = `<span class="line">${start}</span><span class="line">${end}</span>`;
                tr.appendChild(tdTime);

                for (let d = 1; d <= 5; d++) {
                    const td = document.createElement('td');
                    td.dataset.day = String(d); // 1=Monâ€¦5=Fri
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        /********************
         * 2) è³‡æ–™å„²å­˜ / ç¹ªè£½
         ********************/
        const LS_KEY = 'nchu-courses';

        function loadCourses() {
            try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
            catch { return []; }
        }
        function saveCourses(arr) {
            localStorage.setItem(LS_KEY, JSON.stringify(arr));
        }

        /** è³‡æ–™æ ¼å¼ï¼ˆç›¸å®¹æ ¡å‹™ç³»çµ±åŒ¯å‡ºï¼‰ï¼š
         *  [{ m: "6810", n: "è¡Œå‹•é€šè¨Š", c: "B22", e: "EE207",
         *     d: [{ w:2, s:[2,3,4] }]  // w: æ˜ŸæœŸï¼ˆ1~5ï¼‰ï¼Œs: ç¬¬å¹¾ç¯€ï¼ˆå¾ 0 èµ·ç®—ï¼‰
         *  }, ...]
         */
        function renderCourses() {
            // å…ˆæ¸…ç©ºæ ¼å­
            document.querySelectorAll('#tbody td:not(.time-cell)').forEach(td => td.innerHTML = '');

            const courses = loadCourses();
            for (const course of courses) {
                const { n: name = 'èª²ç¨‹', m: code = '', e: room = '', d = [] } = course;
                for (const seg of d) {
                    const w = Number(seg.w);     // 1 ~ 5
                    const ss = (seg.s || []).map(v => Number(v));

                    for (const sec of ss) {
                        // sec å°æ‡‰åˆ° TIME_SLOTS çš„ index
                        const row = tbody.rows[sec];
                        if (!row) continue;

                        const td = row.querySelector(`td[data-day="${w}"]`);
                        if (!td) continue;

                        const div = document.createElement('div');
                        div.className = 'course';
                        div.innerHTML = `
                  <div class="name">${name}</div>
                  <div class="meta">(${code}) Â· ${room || 'â€”'}</div>
                `;
                        td.appendChild(div);
                    }
                }
            }
        }

        /********************
         * 3) åŒ¯å…¥ï¼šJSON / QR
         ********************/
        // å°‡ä»»æ„å­—ä¸²è£¡çš„ç¬¬ä¸€å€‹ {...} ç‰©ä»¶æŠ“å‡ºä¾†
        function extractFirstJSON(text) {
            const start = text.indexOf('{');
            const end = text.lastIndexOf('}');
            if (start !== -1 && end !== -1 && end > start) {
                const maybe = text.slice(start, end + 1);
                try { return JSON.parse(maybe); } catch { }
            }
            return null;
        }

        function importFromJSONString(s) {
            let obj = null;
            try {
                obj = JSON.parse(s);
            } catch {
                // è‹¥ä¸æ˜¯ç´” JSONï¼Œå˜—è©¦å¾å­—ä¸²å–ç¬¬ä¸€æ®µ {...}
                obj = extractFirstJSON(s);
            }
            if (!obj) throw new Error('ç„¡æ³•è§£æ JSON å…§å®¹');

            // æ”¯æ´å–®ä¸€ç‰©ä»¶æˆ–é™£åˆ—
            const arr = Array.isArray(obj) ? obj : [obj];
            saveCourses(arr);
            buildTable(); renderCourses();
            alert('èª²è¡¨å·²åŒ¯å…¥ï¼');
        }

        // æ‰‹å‹•è²¼ä¸Š
        document.getElementById('btn-paste').addEventListener('click', async () => {
            const s = prompt('è«‹è²¼ä¸Š JSONï¼š');
            if (!s) return;
            try { importFromJSONString(s); }
            catch (err) { alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message); }
        });

        // æ¸…ç©º
        document.getElementById('btn-clear').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºèª²è¡¨å—ï¼Ÿ')) {
                saveCourses([]);
                buildTable(); renderCourses();
            }
        });

        /********************
         * 4) QR æƒæå™¨
         ********************/
        const modal = document.getElementById('scanner-modal');
        const btnScan = document.getElementById('btn-scan');
        const btnClose = document.getElementById('scanner-close');
        let qrReader = null;

        btnScan.addEventListener('click', async () => {
            modal.style.display = 'flex';
            if (!qrReader) {
                qrReader = new Html5Qrcode("qr-reader");
            }
            const config = { fps: 10, qrbox: { width: 260, height: 260 } };
            qrReader.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    // æ‹¿åˆ°å­—ä¸² â†’ å˜—è©¦åŒ¯å…¥
                    try {
                        importFromJSONString(decodedText);
                        stopScanner();
                    } catch (err) {
                        console.warn('QR å…§å®¹ï¼š', decodedText);
                        alert('ç„¡æ³•è§£ææ­¤ QR å…§å®¹ï¼Œå·²åˆ—å°åœ¨ console');
                    }
                },
                (err) => { /* ignore scan failure */ }
            ).catch(e => {
                alert('å•Ÿç”¨ç›¸æ©Ÿå¤±æ•—ï¼š' + e);
            });
        });

        function stopScanner() {
            if (qrReader) {
                qrReader.stop().catch(() => { }).finally(() => {
                    modal.style.display = 'none';
                    document.getElementById('qr-reader').innerHTML = ''; // æ¸…ç©ºç•«é¢
                    qrReader = null;
                });
            } else {
                modal.style.display = 'none';
            }
        }
        btnClose.addEventListener('click', stopScanner);
        modal.addEventListener('click', (e) => { if (e.target === modal) stopScanner(); });

        /********************
         * 5) å•Ÿå‹•
         ********************/
        buildTable();
        renderCourses();

        // è¨»å†Š Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.warn);
            });
        }
    </script>
</body>
</html>
